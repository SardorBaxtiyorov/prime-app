<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Phone Authentication</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        input, button {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
        #recaptcha-container {
            margin: 20px 0;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<h1>Telefon raqam orqali ro‘yxatdan o‘tish</h1>
<input type="text" id="phoneNumber" placeholder="+998901234567" />
<button id="sendCodeButton">Kodni yuborish</button>
<div id="recaptcha-container"></div>
<input type="text" id="verificationCode" placeholder="SMS kodini kiriting" />
<button id="verifyCodeButton">Kodni tasdiqlash</button>
<button id="signOutButton" style="display: none;">Chiqish</button>
<p id="status"></p>

<script type="module">
    // Firebase SDK'larni import qilish
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    // Firebase konfiguratsiyasi
    const firebaseConfig = {
        apiKey: "AIzaSyCPHBkoO-oJ-Nl1UZrBXblArbS3LAXQLW4",
        authDomain: "sms-test-app-9cfea.firebaseapp.com",
        projectId: "sms-test-app-9cfea",
        storageBucket: "sms-test-app-9cfea.firebasestorage.app",
        messagingSenderId: "1027752531831",
        appId: "1:1027752531831:web:84073be43e685d74797372",
        measurementId: "G-R75JECTJRL"
    };

    // Firebase'ni boshlash
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();

    // reCAPTCHA sozlash
    try {
        window.recaptchaVerifier = new RecaptchaVerifier(auth, 'recaptcha-container', {
            size: 'invisible',
            callback: (response) => {
                console.log("reCAPTCHA tasdiqlandi!");
                document.getElementById('status').textContent = "reCAPTCHA tasdiqlandi, SMS yuborilmoqda...";
            },
            'expired-callback': () => {
                document.getElementById('status').textContent = "reCAPTCHA muddati tugadi. Qayta urinib ko‘ring.";
                enableSendButton();
            }
        });
    } catch (error) {
        console.error("reCAPTCHA sozlashda xato: ", error);
        document.getElementById('status').textContent = "reCAPTCHA sozlashda xato: " + error.message;
    }

    // Tugmani vaqtincha o‘chirish uchun funksiya
    function disableSendButton() {
        const sendButton = document.getElementById('sendCodeButton');
        sendButton.disabled = true;
        sendButton.textContent = "Iltimos, 60 soniya kuting...";
        setTimeout(enableSendButton, 60000); // 60 soniya kutish
    }

    function enableSendButton() {
        const sendButton = document.getElementById('sendCodeButton');
        sendButton.disabled = false;
        sendButton.textContent = "Kodni yuborish";
    }

    // Tasdiqlash kodini yuborish
    async function sendVerificationCode() {
        const phoneNumber = document.getElementById('phoneNumber').value;
        const appVerifier = window.recaptchaVerifier;

        if (!phoneNumber.match(/^\+\d{10,15}$/)) {
            document.getElementById('status').textContent = "Telefon raqami to‘g‘ri formatda bo‘lishi kerak (masalan, +998901234567)";
            return;
        }

        disableSendButton(); // Tugmani o‘chirish
        try {
            const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, appVerifier);
            window.confirmationResult = confirmationResult;
            document.getElementById('status').textContent = "SMS kodi yuborildi! Kodni kiriting.";
        } catch (error) {
            console.error("SMS yuborishda xato: ", error);
            document.getElementById('status').textContent = `Xato: ${error.message}`;
            if (error.code === 'auth/too-many-requests') {
                document.getElementById('status').textContent += " Juda ko‘p so‘rov yuborildi. Iltimos, 1-2 soatdan keyin qayta urinib ko‘ring.";
            }
            enableSendButton(); // Xato bo‘lsa tugmani qayta yoqish
        }
    }

    // Kodni tasdiqlash
    async function verifyCode() {
        const code = document.getElementById('verificationCode').value;
        if (!window.confirmationResult) {
            document.getElementById('status').textContent = "Avval SMS kodi yuborilishi kerak!";
            return;
        }

        try {
            const result = await window.confirmationResult.confirm(code);
            const user = result.user;
            document.getElementById('status').textContent = `Foydalanuvchi muvaffaqiyatli tasdiqlandi: ${user.phoneNumber}`;
            document.getElementById('signOutButton').style.display = 'block';
        } catch (error) {
            console.error("Kod tasdiqlashda xato: ", error);
            document.getElementById('status').textContent = "Xato: Noto‘g‘ri kod yoki boshqa muammo.";
        }
    }

    // Chiqish funksiyasi
    async function signOutUser() {
        try {
            await signOut(auth);
            document.getElementById('status').textContent = "Foydalanuvchi chiqdi.";
            document.getElementById('signOutButton').style.display = 'none';
            document.getElementById('phoneNumber').value = '';
            document.getElementById('verificationCode').value = '';
            enableSendButton();
        } catch (error) {
            console.error("Chiqishda xato: ", error);
            document.getElementById('status').textContent = "Chiqishda xato: " + error.message;
        }
    }

    // Tugmalarga event listener'lar qo‘shish
    document.getElementById('sendCodeButton').addEventListener('click', sendVerificationCode);
    document.getElementById('verifyCodeButton').addEventListener('click', verifyCode);
    document.getElementById('signOutButton').addEventListener('click', signOutUser);
</script>
</body>
</html>